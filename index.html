#!/bin/sh

set -e

_k0s_latest() {
  curl -sSLf -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/k0sproject/k0s/releases \
    | grep '"tag_name":' \
    | cut -d"\"" -f4 \
    | grep "+k0s" \
    | grep -v -- - \
    | sort -r -t "." -k1,4n \
    | head -1
}

K0S_VERSION=${K0S_VERSION:-"$(_k0s_latest)"}

if [ ! -z "${DEBUG}" ]; then
  set -x
fi

_detect_arch() {
  case $(uname -m) in
    amd64|x86_64) echo "amd64" ;;
    arm64|aarch64) echo "arm64" ;;
    armv7l|armv8l|arm) echo "arm" ;;
    *) echo "Unsupported processor architecture"; return 1 ;;
  esac
}

_download_url() {
  local arch="$(_detect_arch)"

  echo "https://github.com/k0sproject/k0s/releases/download/$K0S_VERSION/k0s-$K0S_VERSION-$arch"
}

if [[ ! ${K0S_VERSION} =~ ^v[0-9]+\.[0-9]+\.[0-9]+\+k0s\.[0-9]+$ ]]; then
  echo "Invalid K0S_VERSION or auto-discovery failed: '${K0s_VERSION}'" >&2
  exit 1
fi

echo "Downloading k0s from URL: $(_download_url)"

curl -sSLf $(_download_url) > /usr/local/bin/k0s
chmod 755 /usr/local/bin/k0s

echo "k0s is now executable in /usr/local/bin"